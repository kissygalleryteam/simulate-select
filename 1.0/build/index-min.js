/*! simulateSelect - v1.0 - 2013-09-17 6:28:36 PM
* Copyright (c) 2013 兰梦; Licensed  */
KISSY.add("gallery/simulateSelect/1.0/index",function(a,b,c,d,e){function f(){var a=this;f.superclass.constructor.apply(a,arguments),a._init.apply(a,arguments)}var g="SELECT",h="simulate-selected",i="data-value",j="J_simulate_value",k="J_option",l="changeValue",m="select",n="afterOptionsChange()",o="afterValueChange";b.all;var p=b.one,q=a.DOM,r=a.each,e=a.Overlay,s='<div class="simulate-select"><span class="J_simulate_value">{value}</span><em></em></div>',t='<div class="simulate-list"><ul>{{#each list}}<li data-value="{{value}}" class="{{#if disabled}}simulate-disabled{{/if}}  {{#if selected}}simulate-selected{{/if}} J_option">{{#if isShowSelectBox}}<input type="{{input}}" name="{{name}}" {{#if selected}}checked=true{{/if}}/>{{/if}}{{text}}</li>{{/each}}</ul></div>',u='<input type="hidden" name="{name}" />';return a.extend(f,c,{_init:function(){var b=this;b.selectNode=b.get("selectNode"),b.selectNode&&(b.selectParent=b.selectNode.parent(),b.selectParent.append(a.substitute(u,{name:b.get("name")})),b.selectNode.getDOMNode().nodeName==g&&b._initNativeSelect(),b._initSimulateSelect(),b._initOptions(),b._initBox(),b._bindEvent(),b._changeValue())},_initNativeSelect:function(){var a=this,b=a.selectNode.val();a.set("name",a.selectNode.attr("name")),a.set("value",b);var c=[];r(a.selectNode.all("option"),function(a){var a=p(a);c.push({text:a.text(),value:a.val(),disabled:a.attr("data-disabled"),selected:a.val()==b})}),a.set("options",c)},_initSimulateSelect:function(){var b=this;if(b.selectNode.children().length&&b.selectNode.getDOMNode().nodeName!=g)return b.simulateSelect=b.selectNode.one("."+j),void 0;var c=b.selectNode.attr("class"),d=q.create(a.substitute(s,{value:b.get("selectTips")}));b.selectParent.getDOMNode().replaceChild(d,b.selectNode.getDOMNode()),b.selectNode=p(d),b.selectNode.addClass(c),b.simulateSelect=b.selectNode.one("."+j)},_initBox:function(){var b=this;b.popup=new e.Popup({srcNode:b.opitonBox,trigger:b.selectNode,triggerType:b.get("eventType"),align:a.merge(b.get("align"),{node:b.selectNode}),effect:{effect:b.get("effect"),duration:b.get("duration")},width:b.get("width"),height:b.get("height")}),b.popup.render()},_bindEvent:function(){var a=this;a.on(o,a._setShowSelectVal,a),a.on(o,a._changeValue,a),a.on(n,a._initOptions,a),a.opitonBox.delegate("click","."+k,a._selectItem,a),a.popup.on("show",function(){a.fire("show",{triggerNode:a.selectNode})}),a.popup.on("hide",function(){a.fire("hide",{triggerNode:a.selectNode})})},_initOptions:function(){var b=this,c=b.get("options");c&&(a.isArray(c)&&b._renderOption(c),"string"==typeof c&&(b.opitonBox=p(c)),b._getValue())},_renderOption:function(a){var b=this;r(a,function(a){a.isShowSelectBox=b.get("isShowSelectBox"),a.input=b.get("multi")?"checkbox":"radio",a.name=b.get("name"),a.selected=a.selected||!1});var c=p(q.create(new d(t).render({list:a})));b.opitonBox?b.opitonBox.html(c.html()):(b.opitonBox=c,b.selectParent.append(c))},_selectItem:function(a){var b=this,c=p(a.currentTarget),d=c.one("input"),e=c.attr(i),f=!0,g=b.get("value");b.get("multi")?c.hasClass(h)?(c.removeClass(h),d&&d.attr("checked",!1),f=!1):(c.addClass(h),d&&d.attr("checked",!0)):(b.opitonBox.all("input").attr("checked",!1),b.opitonBox.all("."+k).removeClass(h),c.addClass(h),d&&d.attr("checked",!0)),b.get("isHideBoxBySelected")&&b.popup.hide(),b.set("value",b._getValue());var j={selectVal:b.get("value"),target:c,checked:f,value:e};g!=b.get("value")&&b.fire(l,j),b.fire(m,j)},_setShowSelectVal:function(){var a=this;if(a.get("isShowSelectValue")){var b=a.get("value")?a.get("value"):a.get("selectTips");a.simulateSelect.html(b)}},_getValue:function(){var a=this,b=[];return r(a.opitonBox.all("."+k),function(a){var c=p(a);c.hasClass(h)&&b.push(c.attr("data-value"))}),b.join(",")},_changeValue:function(){var a=this;a.setValue(a.get("value"))},setValue:function(b){var c=this,d=arguments,e=c.opitonBox.all("."+k),f=c.get("isShowSelectBox");r(e,function(b){var c=p(b);a.inArray(c.attr(i),d)?(c.addClass(h),f&&c.one("input").attr("checked",!0)):(c.removeClass(h),f&&c.one("input").attr("checked",!1))}),c.set("value",b)},getValue:function(){var a=this;return a.get("value")},setSelectedByIndex:function(){var b=this,c=arguments,d=b.opitonBox.all("."+k),e=[];r(d,function(b,d){a.inArray(d,c)&&e.push(p(b).attr(i))}),b.setValue(e.join(","))},getSelectedIndex:function(){var a=this,b=a.opitonBox.all("."+k),c=[];return r(b,function(a,b){p(a).hasClass(h)&&c.push(b)}),c.join(",")},getOptionByIndex:function(a){var b=this,c=b.get("options");return"string"==typeof c?b.opitonBox.all("."+k).item(a):c[a]},changeOpition:function(a){var b=this;b.set("options",a),b._initOptions()},show:function(){var a=this;a.popup.show()},hide:function(){var a=this;a.popup.hide()}},{ATTRS:{selectNode:{value:null,getter:function(a){return"string"==typeof a?p(a):a}},options:{value:null},selectTips:{value:"\u8bf7\u9009\u62e9"},value:{value:"",getter:function(a){return a.toString()}},isShowSelectValue:{value:!0},name:{value:""},multi:{value:!1},isShowSelectBox:{value:!0},eventType:{value:"click"},width:{value:null},height:{value:null},align:{value:{points:["bl","tl"],offset:[0,-1],overflow:{adjustX:0,adjustY:0}}},selectBoxClass:{value:""},isHideBoxBySelected:{value:!1},effect:{value:""},duration:{value:""}}}),f},{requires:["node","base","xtemplate","overlay","./simulate.css"]});